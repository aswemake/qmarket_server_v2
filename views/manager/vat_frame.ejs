<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>큐마켓 관리자</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: sans-serif;
        }

        html {
            height: 100%;
        }
        body {
            height: 100%;
            display: flex;
            flex-direction: column;
            margin: 0;
        }

        img {
            width: 75px;
            height: 75px;
        }
        body>article {
            width: 100%;
            height: 100%;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        table,
        tr,
        td,
        th {
            border-collapse: collapse;
        }

        thead {
            background-color: #F0F0F0;
        }

        th {
            padding: 10px 0px;
        }

        td {
            padding: 10px 0px;
            text-align: center;
        }

        tbody tr {
            border-bottom: 1px solid #F0F0F0;
        }

        .pc {
            display: none;
            font-size: 0.4em;
            font-weight: normal;
            color: red;
        }

        select {
            width: 100px;
            height: 35px;
        }

        #start_date,
        #end_date {
            text-align: center;
        }

        @media screen and (max-width: 768px) {
            * {
                font-size: 0.95em;
            }

            .pc {
                display: inline;
            }
        }
    </style>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.8.18/themes/base/jquery-ui.css" type="text/css" />  
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>  
    <script src="https://code.jquery.com/ui/1.8.18/jquery-ui.min.js"></script>
</head>

<body>
    <div style="display: flex; flex-direction: row; justify-content: space-between;">
        <h1>부가세 신고자료<span class="pc">*PC에 최적화 되어있습니다.</span></h1>
        <div style="align-self: center; margin-right: 20px;">
            <div style="margin-top: 10px;">
                <select id="year">
                    <option value="">년도</option>
                </select>
                <select id="period_type" onchange="search_period_type(this.options.selectedIndex)">
                    <option value="">기간유형</option>
                    <option value="quarter">분기별</option>
                    <option value="month">월별</option>
                </select>
                <select id="period_type_detail">
                </select>
                <input type="button" value="기간설정" onclick="set_date()">
            </div>
            <div style="margin-top: 10px; margin-bottom: 10px;">
                <input type="text" id="start_date" value="시작일"> ~ 
                <input type="text" id="end_date" value="종료일">
                <input type="button" value="조회" onclick="redirect()">
            </div>
        </div>
    </div>
    <article>
        <iframe id="content" src="/manager/<%= data.partner_idx %>/vat?page=1"></iframe>  
    </article>
    <script>
        function redirect() {
            var start_date = `${$('#start_date').datepicker({ dateFormat: 'YYYY-mm-dd' }).val()}`;
            var end_date = `${$('#end_date').datepicker({ dateFormat: 'YYYY-mm-dd' }).val()}`;
            
            if (start_date == "시작일") start_date = `2011-01-01`; // default 시작 날짜 추후 수정
            if (end_date == "종료일") {
                var now = new Date(); now.setDate(now.getDate());
                var year = now.getFullYear();
                var month = ("0" + (1 + now.getMonth())).slice(-2);
                var day = ("0" + now.getDate()).slice(-2);
                end_date = `${year}-${month}-${day}`;
            }

            start_date = `"${start_date}"`;
            end_date = `"${end_date} 23:59:59"`;

            var uri = '/manager/<%=data.partner_idx%>/vat';
            var query_string = `?page=1&start_date=${start_date}&end_date=${end_date}`;
            var address = uri + query_string;

            document.getElementById('content').src = address;
        }

        window.onload = function () {
            let year = document.getElementById('year');
            let current_year = (new Date()).getFullYear();
            for (let i = current_year - 3; i <= current_year; i++) {
                let option = document.createElement('option');
                option.value = i;
                option.text = i;
                year.appendChild(option);
            }
        }

        $(function() {
            $.datepicker.setDefaults({
                dateFormat: 'yy-mm-dd',
                showOtherMonths: true,     // 빈 공간에 현재월의 앞뒤월의 날짜를 표시
                showMonthAfterYear:true,   // 년도 먼저 나오고, 뒤에 월 표시
                changeYear: true,          // 콤보박스에서 년 선택 가능
                changeMonth: true,         // 콤보박스에서 월 선택 가능
                monthNamesShort: ['1','2','3','4','5','6','7','8','9','10','11','12'],                   // 달력의 월 부분 텍스트
                monthNames: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'], // 달력의 월 부분 Tooltip 텍스트
                dayNamesMin: ['일','월','화','수','목','금','토'],                                       // 달력의 요일 부분 텍스트
                dayNames: ['일요일','월요일','화요일','수요일','목요일','금요일','토요일'],                // 달력의 요일 부분 Tooltip 텍스트
                minDate: '-11y',
                maxDate: 'today'
            });
            // esc 입력시 datepicker 초기화 
            $('#start_date').datepicker().keyup(function(e) {
                if (e.keyCode == 27) $.datepicker._clearDate(this);
            });
            $('#end_date').datepicker().keyup(function(e) {
                if (e.keyCode == 27) $.datepicker._clearDate(this);
            });
        });

        function search_period_type(index) {
            let peroid_type_detail = document.getElementById('period_type_detail');
            peroid_type_detail.options.length = 0;
            if (index == 1) {      // 분기별
                for (let i = 1; i <= 4; i++) {
                    let option = document.createElement('option');
                    option.value = i;
                    option.text = i + "분기";
                    peroid_type_detail.appendChild(option);
                }
            }
            else if (index == 2) { // 월별
                for (let i = 1; i <= 12; i++) {
                    let option = document.createElement('option');
                    option.value = i;
                    option.text = i + "월";
                    peroid_type_detail.appendChild(option);
                }
            }
        }

        function set_date() {
            let year = document.getElementById('year').value;
            let period_type = document.getElementById('period_type').value;
            let period_type_detail = Number(document.getElementById('period_type_detail').value);
            let date = new Object();
            date.start = new Object();
            date.end = new Object();
            date.start.year = 0; date.start.month = 0; date.start.day = 0;
            date.end.year = 0; date.end.month = 0; date.end.day = 0;

            if (!year) { // 년도 설정이 안되어 있을 경우 
                // 시작일을 2011년 1월 1일로 설정 (추후 변경 예정)
                date.start.year = 2011;
                date.start.month = 1;
                date.start.day = 1;
                date.end.year = 1;
                // 종료일을 오늘 날짜로 설정
                var now = new Date();
                date.end.year = now.getFullYear();
                date.end.month = ("0" + (1 + now.getMonth())).slice(-2);
                date.end.day = ("0" + now.getDate()).slice(-2);
            } else { // 년도 설정이 되어있는 경우
                date.start.year = year;
                date.end.year = year;
                if (period_type == "quarter") {
                    date.start.month = 1 + 3 * (period_type_detail - 1);
                    date.start.day = 1;
                    date.end.month = date.start.month + 2;
                    date.end.day = (new Date(year, date.end.month, 0)).getDate();
                } else if (period_type == "month") {
                    date.start.month = period_type_detail;
                    date.start.day = 1;
                    date.end.month = period_type_detail;
                    date.end.day = (new Date(year, date.end.month, 0)).getDate();
                } else {
                    date.start.month = 1; date.start.day = 1; date.end.month = 12; date.end.day = 31;
                }
            }

            $('#start_date').datepicker().datepicker("setDate", new Date(date.start.year, date.start.month - 1, date.start.day));
            $('#end_date').datepicker().datepicker("setDate", new Date(date.end.year, date.end.month - 1, date.end.day));
        }
    </script>
    <script>
        /******************* 큐메이커, 파트너 마트 선택 부분입니다 추후 사용 예정 *******************/
        // function move() {
        //     let type = document.getElementById('type');
        //     type = type.options[type.selectedIndex].value;
        //     if (type == "qmaker" || type == "partner") window.location.href = "/manager/product/vat/" + type;
        // }
        /********************************************************************************************/

        /******************************** 추후 구현 예정입니다!!! ********************************/
        // function download(element) {
        //     // 쿼리스트링 type 설정
        //     let type = document.getElementById('type');
        //     type = type.options[type.selectedIndex].value;
        //     if (type === "qmaker") type = "큐메이커";
        //     else if (type === "partner") type = "파트너마트";
        //     // 쿼리스트링 name, address 설정
        //     let col_count = 3;
        //     let row_num = (element.parentNode.parentNode.rowIndex - 1) * col_count;
        //     let name = document.getElementsByTagName('td')[row_num].childNodes[0].nodeValue.trim();
        //     let address = document.getElementsByTagName('td')[row_num + 1].childNodes[0].nodeValue.trim();
        //     // 쿼리스트링 start_date, end_date 설정
        //     start_date = $('#start_date').datepicker({ dateFormat: 'YYYY-mm-dd' }).val();
        //     end_date = $('#end_date').datepicker({ dateFormat: 'YYYY-mm-dd' }).val();
        //     if (start_date == "시작일") start_date = "2011-01-01"; // default 시작 날짜 추후 수정
        //     if (end_date == "종료일") {
        //         var now = new Date();
        //         var year = now.getFullYear();
        //         var month = ("0" + (1 + now.getMonth())).slice(-2);
        //         var day = ("0" + now.getDate()).slice(-2);
        //         end_date = year + "-" + month + "-" + day;
        //     }

        //     // URI 설정
        //     let uri = "/manager/product/vat/download";
        //     //let query_string = `?type=${type}&name=${name}&address=${address}&start_date=${start_date}&end_date=${end_date}`;
        //     let query_string = `?type=${type}&name=${name}&address=${address}&start_date=${start_date}&end_date=${end_date}`;
        //     uri += query_string;

        //     // API 호출
        //     var xhttp = new XMLHttpRequest();
        //     xhttp.open("GET", uri);
        //     xhttp.responseType = "blob";
        //     xhttp.setRequestHeader('Content-Type', 'application/json');
        //     xhttp.onload = function () {
        //         if (this.status == 200) {
        //             var blob = this.response;
        //             var link = document.createElement('a');
        //             link.href = window.URL.createObjectURL(blob);
        //             link.download = "큐마켓 - 부가세 신고 자료.xlsx";
        //             link.click();
        //         }
        //     }
        //     xhttp.send();
        // }
        /********************************************************************************************/
    </script>
</body>

</html>
