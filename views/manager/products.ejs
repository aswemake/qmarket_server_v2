<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>큐마켓 관리자</title>
    <style>
        * {
            box-sizing: border-box; 
            font-family: sans-serif;
        }
    
        table {
            width: 100%;
        }

        img {
            width: 75px;
            height: 75px;
        }

        table,
        tr,
        td,
        th {
            border-collapse: collapse;
        }

        thead {
            background-color: #F0F0F0;
        }

        th {
            padding: 10px 0px;
        }

        td {
            padding: 10px 0px;
            text-align: center;
        }

        tbody tr {
            border-bottom: 1px solid #F0F0F0;
        }

        .pc {
            display: none;
            font-size: 0.4em;
            font-weight: normal;
            color: red;
        }

        .page_num {
            width : 99.5%;   
        }
        .page_num, a {  
            text-align: center;
            text-decoration: none;
        }
        .a_other_page {
            color: #646464;
		}
        .a_current_page {
            font-size: 150%;
            color: black;
            pointer-events: none;
		}

        @media screen and (max-width: 768px) {
            * {
                font-size: 0.95em;
            }

            .pc {
                display: inline;
            }
        }
    </style>
</head>

<body>
    <table>
        <thead>
            <tr>
                <th>
                    바코드
                </th>
                <th>
                    카테고리
                </th>
                <th>
                    브랜드
                </th>
                <th>
                    상품 상세 이름
                </th>
                <th>
                    규격
                </th>
                <th>
                    가격
                </th>
                <th>
                    수량
                </th>
                <th>
                    기능
                </th>
            </tr>
        </thead>
        <tbody>
            <% for(let i=0;i < data.products.length; i++) { %>
            <tr>
                <td>
                    <%= data.products[i].barcode %>
                </td>
                <td>
                    <%= data.products[i].category %>
                </td>
                <td>
                    <%= data.products[i].brand %>
                </td>
                <td>
                    <%= data.products[i].detail_name %>
                </td>
                <td>
                    <%= data.products[i].standard %>
                </td>
                <td>
                    <div style="display:flex;flex-direction: column;">
                        <%= data.products[i].price %>
                        <button onclick="changePrice('<%=data.products[i].product_id%>','<%=data.products[i].price%>')"
                            style="display: block;">수정하기</button>
                    </div>
                </td>
                <td>
                    <div style="display:flex;flex-direction: column;">
                        <%= data.products[i].count %>
                        <button onclick="changeAmount('<%=data.products[i].product_id%>','<%=data.products[i].count%>')"
                            style="display: block;">수정하기</button>
                    </div>
                </td>
                <td>
                    <button onclick="DisableProduct('<%=data.products[i].product_id%>', '<%=data.products[i].detail_name%>')">상품 삭제</button>
                </td>
            </tr>
            <% } %>
        </tbody>
    </table>
    <div class = "page_num">
        <% var current_page = data.current_page_num;
           var last_page = data.last_page_num;
           if(current_page < 6){
               if(last_page < 10){
                   for(let i = 1; i <= last_page; i++){
                       if(i == current_page){ %>
                           <a href="#" class = "a_current_page" onclick="products_move_page('<%= data.partner_idx %>', '<%= data.current_category %>', '<%= data.current_keyword %>', this)">
                               <%= i %>
                           </a>
        <%             } else { %>
                           <a href="#" class = "a_other_page" onclick="products_move_page('<%= data.partner_idx %>', '<%= data.current_category %>', '<%= data.current_keyword %>', this)">
                               <%= i %>
                           </a>
        <%             }
                   }
               } else {
                   for(let i = 1; i <= 10; i++){ 
                       if(i == current_page){ %>
                           <a href="#" class = "a_current_page" onclick="products_move_page('<%= data.partner_idx %>', '<%= data.current_category %>', '<%= data.current_keyword %>', this)">
                               <%= i %>
                           </a>
        <%             } else { %>
                           <a href="#" class = "a_other_page" onclick="products_move_page('<%= data.partner_idx %>', '<%= data.current_category %>', '<%= data.current_keyword %>', this)">
                               <%= i %>
                           </a>
        <%             }
                   }
               }
           } else if(last_page - current_page < 4){
               for(let i = 0; i < 10; i++){
                   if(last_page - 9 + i < 1){}
                   else { 
                       if(last_page - 9 + i == current_page){ %>
                           <a href="#" class = "a_current_page" onclick="products_move_page('<%= data.partner_idx %>', '<%= data.current_category %>', '<%= data.current_keyword %>', this)">
                               <%= last_page - 9 + i %>
                           </a>
        <%             } else { %>
                           <a href="#" class = "a_other_page" onclick="products_move_page('<%= data.partner_idx %>', '<%= data.current_category %>', '<%= data.current_keyword %>', this)">
                               <%= last_page - 9 + i %>
                           </a>
        <%             }
                   }
               }
           } else {
               for(let i = 0; i < 10; i++){
                   if(current_page - 5 + i == current_page){ %>
                       <a href="#" class = "a_current_page" onclick="products_move_page('<%= data.partner_idx %>', '<%= data.current_category %>', '<%= data.current_keyword %>', this)">
                           <%= current_page - 5 + i %>
                       </a>
        <%         } else { %>
                       <a href="#" class = "a_other_page" onclick="products_move_page('<%= data.partner_idx %>', '<%= data.current_category %>', '<%= data.current_keyword %>', this)">
                           <%= current_page - 5 + i %>
                       </a>
        <%         }
               }
           } %>
       </div>
    <script src="/javascripts/myScript.js"></script>
    <script>
        function changePrice(id, price) {
            var text = parseInt(prompt('변경할 가격을 입력해주세요', price));
            if (!(!isNaN(text) && 0 < text)) {
                alert("유효하지 않은 가격입니다.")
            } else {
                var xhttp = new XMLHttpRequest()
                var requestBody = {
                    product_id: id,
                    price: text,
                }
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        if (text === price) {
                            alert('변경된 사항이 없습니다.');
                        } else {
                            alert('가격이 ' + text + '(원)으로 변경되었습니다.');
                        }
                        window.location.reload();
                    }
                }
                xhttp.open("PUT", "/manager/products/change/price");
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send(JSON.stringify(requestBody))
            }
        }

        function changeAmount(id, count) {
            var amount = parseInt(prompt('변경할 수량을 입력해주세요', count));
            if (!(!isNaN(amount) && 0 <= amount)) {
                alert("유효하지 않은 수량입니다.")
            } else {
                var xhttp = new XMLHttpRequest()
                var requestBody = {
                    product_id: id,
                    count: amount,
                }
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        if (amount === count) {
                            alert('변경된 사항이 없습니다.');
                        } else {
                            alert('수량이 ' + (amount - count) + '만큼 변경되었습니다.');
                        }
                        window.location.reload();
                    }
                }
                xhttp.open("PUT", "/manager/products/change/count");
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send(JSON.stringify(requestBody))
            }
        }
        function DisableProduct(id, detail_name) {
            var returnValue = confirm("상품을 삭제하시겠습니까?")
            if(returnValue){
                var xhttp = new XMLHttpRequest()
                var requestBody = {
                    product_id: id,
                }
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        alert('상품이 정상적으로 삭제되었습니다.');
                        window.location.reload();
                    } else if (this.readyState == 4 && this.status == 400) {
                        alert('상품 삭제에 실패했습니다.');
                        window.location.reload();
                    }
                }
                xhttp.open("PUT", "/manager/products/change/enabled");
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send(JSON.stringify(requestBody));
            } else {
                alert('상품 삭제가 취소되었습니다.');
                window.location.reload();
            }
        }
        // // 상품 삭제 기능 -> 추후 사용 (파트너 입장에서는 완전 삭제)
        // function deleteProduct(id, detail_name) {
        //     if (prompt(detail_name + "상품을 삭제하시겠습니까? (삭제를 희망할 시 \"삭제\" 입력)") == "삭제") {
        //         var xhttp = new XMLHttpRequest()
        //         var requestBody = {
        //             product_id: id,
        //         }
        //         xhttp.onreadystatechange = function () {
        //             if (this.readyState == 4 && this.status == 200) {
        //                 alert('상품이 정상적으로 삭제되었습니다.');
        //                 window.location.reload();
        //             } else if (this.readyState == 4 && this.status == 400) {
        //                 alert('상품 삭제에 실패했습니다.');
        //                 window.location.reload();
        //             }
        //         }
        //         xhttp.open("PUT", "/manager/products/change/enabled");
        //         xhttp.setRequestHeader('Content-Type', 'application/json')
        //         xhttp.send(JSON.stringify(requestBody));
        //     }
        // }

    </script>
</body>

</html>
