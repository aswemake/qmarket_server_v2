<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>큐마켓 관리자</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: sans-serif;
        }

        table {
            width: 100%;
        }

        img {
            width: 75px;
            height: 75px;
        }

        table,
        tr,
        td,
        th {
            border-collapse: collapse;
        }

        thead {
            background-color: #F0F0F0;
        }

        th {
            padding: 10px 0px;
        }

        td {
            padding: 10px 0px;
            text-align: center;
        }

        tbody tr {
            border-bottom: 1px solid #F0F0F0;
        }

        .pc {
            display: none;
            font-size: 0.4em;
            font-weight: normal;
            color: red;
        }

        @media screen and (max-width: 768px) {
            * {
                font-size: 0.95em;
            }

            .pc {
                display: inline;
            }
        }
    </style>
</head>

<body>
    <div style="display: flex; flex-direction: row; justify-content: space-between;">
        <h1>상품 재고관리<span class="pc">*PC에 최적화 되어있습니다.</span></h1>
        <div style="align-self: center;">
            <input id="search" type="text">
            <button id="search_button" onclick="search()">검색</button>
        </div>
    </div>
    <table>
        <thead>
            <tr>
                <th>
                    상품 이미지
                </th>
                <th>
                    카테고리
                </th>
                <th>
                    브랜드
                </th>
                <th>
                    상품 상세 이름
                </th>
                <th>
                    가격
                </th>
                <th>
                    할인율
                </th>
                <th>
                    판매가격
                </th>
                <th>
                    수량
                </th>
                <th colspan="3">
                    기능
                </th>
            </tr>
        </thead>
        <tbody>
            <% for(let i=0;i < data.length; i++) { %>
            <tr>
                <td>
		    <img src="<%= data[i].img %>"/> 
		</td> 
		<td>
                    <%= data[i].category %>
                </td>
                <td>
                    <%= data[i].brand %>
                </td>
                <td>
                    <%= data[i].detail_name %>
                </td>
                <td>
                    <div style="display:flex;flex-direction: column;">
                        <%= data[i].price %>
                        <button onclick="changePrice('<%=data[i].product_id%>','<%=data[i].price%>')"
                            style="display: block;">수정하기</button>
                    </div>
                </td>
                <td>
                    <div style="display:flex;flex-direction: column;">
                        <%= data[i].sale_ratio%>
                        <button onclick="changeSale('<%=data[i].product_id%>','<%=data[i].sale_ratio%>')"
                            style="display: block;">수정하기</button>
                    </div>
                </td>
                <td>
                    <%= data[i].saled_price%>
                </td>
                <td>
                    <div style="display:flex;flex-direction: column;">
                        <%= data[i].count %>
                        <button onclick="changeAmount('<%=data[i].product_id%>','<%=data[i].count%>')"
                            style="display: block;">수정하기</button>
                    </div>
                </td>
                <td colspan="3">
                    <button
                        onclick="deleteProduct('<%=data[i].product_id%>','<%=data[i].detail_name%>')">상품삭제하기</button>
                    <button onclick="enrollEvent('<%=data[i].product_id%>')">이벤트등록하기</button>
                    <button onclick="dismissEvent('<%=data[i].product_id%>')">이벤트해제하기</button>
                </td>
            </tr>
            <% } %>
        </tbody>
    </table>
    <!-- 페이지 넘기기, move 추가 필요 -->
    <div class = "page_num">
     <% var current_page = data.current_page_num;
        var last_page = data.last_page_num;
        if(current_page < 6){
            if(last_page < 10){
                for(let i = 1; i <= last_page; i++){
                    if(i == current_page){ %>
                        <a href="#" class = "a_current_page" onclick="move()">
                            <%= i %>
                        </a>
     <%             } else { %>
                        <a href="#" class = "a_other_page" onclick="move()">
                            <%= i %>
                        </a>
     <%             }
                }
            } else {
                for(let i = 1; i <= 10; i++){ 
                    if(i == current_page){ %>
                        <a href="#" class = "a_current_page" onclick="move()">
                            <%= i %>
                        </a>
     <%             } else { %>
                        <a href="#" class = "a_other_page" onclick="move()">
                            <%= i %>
                        </a>
     <%             }
                }
            }
        } else if(last_page - current_page < 4){
            for(let i = 0; i < 10; i++){
                if(last_page - 9 + i < 1){}
                else { 
                    if(last_page - 9 + i == current_page){ %>
                        <a href="#" class = "a_current_page" onclick="move()">
                            <%= last_page - 9 + i %>
                        </a>
     <%             } else { %>
                        <a href="#" class = "a_other_page" onclick="move()">
                            <%= last_page - 9 + i %>
                        </a>
     <%             }
                }
            }
        } else {
            for(let i = 0; i < 10; i++){
                if(current_page - 5 + i == current_page){ %>
                    <a href="#" class = "a_current_page" onclick="move()">
                        <%= current_page - 5 + i %>
                    </a>
     <%         } else { %>
                    <a href="#" class = "a_other_page" onclick="move()">
                        <%= current_page - 5 + i %>
                    </a>
     <%         }
            }
        } %>
    </div>
    <script>
        function changePrice(id, price) {
            var text = parseInt(prompt('변경할 가격을 입력해주세요', price));
            if (!(!isNaN(text) && 0 < text)) {
                alert("유효하지 않은 가격입니다.")
            } else {
                var xhttp = new XMLHttpRequest()
                var requestBody = {
                    price: text,
                }
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        if (text === price) {
                            alert('변경된 사항이 없습니다.');
                        } else {
                            alert('가격이 ' + text + '(원)으로 변경되었습니다.');
                        }
                        window.location.reload();
                    }
                }
                xhttp.open("PUT", "/manager/product/inventory/change/price?product_id=" + id);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send(JSON.stringify(requestBody))
            }
        }

        function changeSale(id, sale_ratio) {
            var text = parseFloat(prompt('변경할 할인율을 입력해주세요', sale_ratio));
            if (!(!isNaN(text) && 0 <= text && text < 1)) {
                alert("유효하지 않은 할인율입니다.")
            } else {
                var xhttp = new XMLHttpRequest()
                var requestBody = {
                    sale_ratio: text,
                }
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        if (text === sale_ratio) {
                            alert('변경된 사항이 없습니다.');
                        } else {
                            alert('할인율이 ' + text + '으로 변경되었습니다.');
                        }
                        window.location.reload();
                    }
                }
                xhttp.open("PUT", "/manager/product/inventory/change/sale_ratio?product_id=" + id);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send(JSON.stringify(requestBody))
            }
        }

        function changeAmount(id, count) {
            var amount = parseInt(prompt('변경할 수량을 입력해주세요', count));
            if (!(!isNaN(amount) && 0 <= amount)) {
                alert("유효하지 않은 수량입니다.")
            } else {
                var xhttp = new XMLHttpRequest()
                var requestBody = {
                    count: amount,
                }
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        if (amount === count) {
                            alert('변경된 사항이 없습니다.');
                        } else {
                            alert('수량이 ' + (amount - count) + '만큼 변경되었습니다.');
                        }
                        window.location.reload();
                    }
                }
                xhttp.open("PUT", "/manager/product/inventory/change/count?product_id=" + id);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send(JSON.stringify(requestBody))
            }
        }

        function deleteProduct(id, detail_name) {
            if (prompt(detail_name + "상품을 삭제하시겠습니까? (삭제를 희망할 시 \"삭제\" 입력)") == "삭제") {
                var xhttp = new XMLHttpRequest()
                var requestBody = {
                    product_id: id,
                }
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        alert('상품이 정상적으로 삭제되었습니다.');
                        window.location.reload();
                    } else if (this.readyState == 4 && this.status == 400) {
                        alert('상품 삭제에 실패했습니다.');
                        window.location.reload();
                    }
                }
                xhttp.open("DELETE", "/manager/product/inventory/change/delete");
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send(JSON.stringify(requestBody));
            }
        }

        function enrollEvent(id) {
            var event_price = parseInt(prompt('이벤트 가격을 입력해주세요'));
            if (!(!isNaN(event_price) && 0 < event_price)) {
                alert("유효하지 않은 가격입니다.")
            } else {
                var xhttp = new XMLHttpRequest()
                var requestBody = {
                    price: event_price
                }
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 400) {
                        alert("이벤트 등록에 실패하였습니다.")
                    } else if (this.readyState == 4 && this.status == 202) {
                        alert("이미 이벤트로 등록되어 있는 상품입니다.")
                    } else if (this.readyState == 4 && this.status == 200) {
                        alert("이벤트가 정상적으로 등록되었습니다.")
                        window.location.reload();
                    }
                }
                xhttp.open("PUT", "/manager/product/inventory/change/event/register?product_id=" + id);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send(JSON.stringify(requestBody))
            }
        }

        function dismissEvent(id) {
            if (confirm("이벤트를 해제하시겠습니까?")) {
                var xhttp = new XMLHttpRequest()
                var requestBody = {
                    product_id: id,
                }
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 202) {
                        alert('이벤트로 등록된 상품이 아닙니다.');
                    } else if (this.readyState == 4 && this.status == 200) {
                        alert('이벤트가 정상적으로 해제되었습니다.')
                        window.location.reload();
                    } else if (this.readyState == 4 && this.status == 400) {
                        alert('이벤트 해제에 실패했습니다.');
                    }
                }
                xhttp.open("PUT", "/manager/product/inventory/change/event/terminate");
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send(JSON.stringify(requestBody));
            }
        }

        document.getElementById("search").addEventListener("keyup", function(event) {
            if(event.keyCode === 13) {
                event.preventDefault();
                document.getElementById("search_button").click();
            }
        })
        function search() {
            var search = document.getElementById("search")
            if (search.value.trim() === "") {
                alert("검색어를 입력해주세요.")
                return;
            } else if (search.value.length <= 1) {
                alert("검색어를 최소 2자 이상 입력해주세요.")
                return;
            }
            // var requestBody = {
            //     search: search.value,
            // }
            //console.log(data);
            var xhttp = new XMLHttpRequest()
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    window.location.href = xhttp.responseURL;
                } else if (this.readyState == 4 && this.status == 204) {
                    search.value = '';
                    alert("검색 결과가 존재하지 않습니다.")
                }
            }
            xhttp.open("GET", "/manager/product/inventory?search=" + search.value);
            xhttp.setRequestHeader('Content-Type', 'application/json');
            xhttp.send();
        }
    </script>
</body>

</html>
